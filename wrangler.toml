name = "hdb-autonomous-agent"
main = "src/index.ts"
compatibility_date = "2025-04-03"
compatibility_flags = ["nodejs_compat"]

# Build command for frontend assets
[build]
command = "npm run build"

# Static Assets Configuration (for React SPA)
# CRITICAL: run_worker_first = true ensures Worker has full routing control
# This prevents asset server from intercepting WebSocket upgrades
[assets]
directory = "./client/dist"
binding = "ASSETS"
not_found_handling = "single-page-application"
run_worker_first = true

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "hbd-advisor"
database_id = "781a9476-2cf0-43fc-94fc-742a16e39af5"

# KV Namespace for caching (FX rates, etc.)
[[kv_namespaces]]
binding = "KV_CACHE"
id = "80f8c30b48ad4112ba0b5d27e573f6eb"

# Durable Object Binding for Agent
[[durable_objects.bindings]]
name = "ADVISOR_AGENT"
class_name = "AdvisorAgent"

# Durable Object Binding for WebSocket Server
[[durable_objects.bindings]]
name = "WS_HANDLER"
class_name = "WebSocketServer"

# Workflow Binding
[[workflows]]
name = "market-scan-workflow"
binding = "MARKET_SCAN_WORKFLOW"
class_name = "MarketScanWorkflow"

# CRITICAL: Use new_sqlite_classes for SQLite storage backend on new DO classes
# This enables the SQL API and state management features in the Agents SDK
[[migrations]]
tag = "v1"
new_sqlite_classes = ["AdvisorAgent"]

# Migration for WebSocketServer Durable Object
[[migrations]]
tag = "v2"
new_classes = ["WebSocketServer"]
